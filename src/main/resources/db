create table Person(
    id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    username varchar(100) unique not null,
    password varchar(100) not null,
    email varchar(120),
    year int check ( year>1900 ),
    role varchar not null
);

create table post_image(
    id int generated by default as identity primary key,
    path varchar not null
);

create table post(
    id int primary key generated by default as identity,
    person_id int references person(id) on delete cascade,
    text varchar(500) not null,
    date timestamp,
    img_id int references post_image(id) on delete set null
);

create table post_like(
    id int primary key generated by default as identity,
    person_id int references person(id) on delete cascade,
    post_id int references post(id) on delete cascade,
    count int check ( count>=0 ) not null
);

create table comment_image(
    id int primary key generated by default as identity,
    path varchar
);

create table comment
(
    id        int primary key generated by default as identity,
    person_id int references person (id) on delete cascade,
    post_id   int references post (id) on delete cascade,
    text      varchar(400) not null,
    date      timestamp,
    image_id  int          references comment_image (id) on delete set null
);

CREATE INDEX idx_comment_person_id ON comment(person_id);
CREATE INDEX idx_comment_post_id ON comment(post_id);
CREATE INDEX idx_img_id ON post(img_id);
CREATE INDEX idx_img_id ON post(person_id);
CREATE INDEX idx_post_like_post_id ON post_like(post_id);
CREATE INDEX idx_post_like_post_id ON post_like(person_id);

alter table post drop column img_id;
alter table post_image add column post_id int references post(id) on delete cascade;
CREATE INDEX idx_post_image_post_id ON post_image(post_id);

alter table comment
    drop column image_id;

alter table comment_image add column comment_id int references comment(id) on delete cascade;
CREATE INDEX idx_comment_image_comment_id ON comment_image(comment_id);
alter table post_like
    drop column count;

alter table person add column avatar varchar